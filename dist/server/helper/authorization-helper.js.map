{"version":3,"sources":["../../../src/server/helper/authorization-helper.js"],"names":["Constants","httpService","Records","authorize","iss","launch","getaAuthorizeURL","bind","catch","console","log","accessToken","code","state","getAccessToken","userAuthenticationModel","find","requestBody","AccessTokenRequestBody","ServerCall","post","TOKEN_URL","POSTHeader","result","AccessToken","patient","data","access_token","buildState","issURl","decodeURIComponent","get","AuthorizationHeader","authorizationURL","rest","security","extension","filter","ext","url","valueUri","tokenURL","authModel","UserAuthentication","save","redirectUrl","responseType","clientId","scope","Math","floor","random","Date","now"],"mappings":"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","file":"authorization-helper.js","sourcesContent":["\"use strict\";\nimport co from 'co';\nimport * as Constants from '../util/constants';\nimport * as httpService from '../service/http-service'\nimport * as Records from '../models/models';\nimport UserAuthenticationModel from '../models/UserAuthenticationSchema';\nimport {ActiveEnv, FHIRConfig} from '../config/app-config';\n\nexport const authorize = (iss, launch) =>\n    co(getaAuthorizeURL.bind(this, iss, launch))\n        .catch(console.log);\n\nexport const accessToken = (code, state) =>\n    co(getAccessToken.bind(this, code, state))\n        .catch(console.log);\n\nconst getAccessToken = function* (code, state) {\n    const userAuthenticationModel = UserAuthenticationModel.find(state);\n    console.log(userAuthenticationModel); \n    const requestBody = new Records.AccessTokenRequestBody({ code });\n    const result = yield ServerCall.post(Constants.TOKEN_URL, requestBody, new Records.POSTHeader());\n    return new Records.AccessToken({ patient: result.data.patient, accessToken: result.data.access_token })\n};\n\nconst getaAuthorizeURL = function* (iss, launch) {\n    const state = buildState(launch);\n    const issURl = `${decodeURIComponent(iss)}/metadata`;\n    const result = yield httpService.get(issURl, new Records.AuthorizationHeader());\n    const authorizationURL = result.data.rest[0].security.extension[0].extension.filter(ext => ext.url === 'authorize')[0].valueUri;\n    const tokenURL = result.data.rest[0].security.extension[0].extension.filter(ext => ext.url === 'token')[0].valueUri;\n    const authModel = new Records.UserAuthentication({\n        iss, state, authorizationURL, tokenURL\n    })\n    yield UserAuthenticationModel.save(authModel);\n    const redirectUrl = authorizationURL +\n        '?response_type=' + FHIRConfig.get(ActiveEnv).responseType +\n        '&client_id=' + FHIRConfig.get(ActiveEnv).clientId +\n        '&redirect_uri=' + FHIRConfig.get(ActiveEnv).redirectUrl +\n        '&scope=' + FHIRConfig.get(ActiveEnv).scope +\n        '&launch=' + launch +\n        '&state=' + state +\n        '&aud=' + iss;\n    return redirectUrl;\n};\n\nconst buildState = (launch) => `${launch}${Math.floor(Math.random() * 100000, 1)}${Date.now()}`;\n\n\n"]}