{"version":3,"sources":["../../../src/server/helper/authorization-helper.js"],"names":["Constants","httpService","Records","Exceptions","authorize","iss","launch","authorizeHelper","bind","accessToken","code","state","accessTokenHelper","authorizationCode","patient","findByState","userAuthenticationModel","AuthenticationError","requestBody","AccessTokenRequestBody","post","tokenURL","POSTHeader","response","data","access_token","updated_at","Date","update","_id","Authentication","EXPIRATION_TIME","authenticated","aud","response_type","client_id","redirect_uri","scope","params","get","buildState","issURl","decodeURIComponent","AuthorizationHeader","extension","rest","security","authorizationURL","filter","ext","url","valueUri","authModel","UserAuthentication","save","model","_extend","buildRedirectUrl","Object","keys","map","key","join","Math","floor","random","now"],"mappings":"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","file":"authorization-helper.js","sourcesContent":["\"use strict\";\nimport co from 'co';\nimport * as Constants from '../util/constants';\nimport * as httpService from '../service/http-service'\nimport * as Records from '../models/models';\nimport UserAuthenticationModel from '../models/UserAuthenticationSchema';\nimport { ActiveEnv, FHIRConfig } from '../config/app-config';\nimport * as Exceptions from '../util/exceptions';\nimport util from 'util';\n\n//public methods\nexport const authorize = (iss, launch) => co(authorizeHelper.bind(this, iss, launch));\n\nexport const accessToken = (code, state) => co(accessTokenHelper.bind(this, code, state));\n\n\n//private methods\nconst accessTokenHelper = function* (authorizationCode, state) {\n    let patient, accessToken;\n    const [userAuthenticationModel] = yield UserAuthenticationModel.findByState(state);\n    if(!userAuthenticationModel) throw new Exceptions.AuthenticationError('Invalid Authentication parameters');\n    if (!userAuthenticationModel.accessToken) {\n        const requestBody = new Records.AccessTokenRequestBody({ code: authorizationCode });\n        const response = yield httpService.post(userAuthenticationModel.tokenURL, requestBody, new Records.POSTHeader());\n        ({ patient } = response.data);\n        accessToken = response.data.access_token;\n        const updated_at = new Date();\n        yield UserAuthenticationModel.update(userAuthenticationModel._id,\n            { authorizationCode, patient, accessToken, updated_at });\n        return new Records.Authentication({ state });\n    } else {\n        return (new Date() - userAuthenticationModel.updated_at < Constants.EXPIRATION_TIME) ?\n            new Records.Authentication({ state }) :\n            new Records.Authentication({ authenticated: false, iss: userAuthenticationModel.iss, launch: userAuthenticationModel.launch });\n    }\n};\n\nconst authorizeHelper = function* (iss, launch) {\n    const aud = iss;\n    let response_type, client_id, redirect_uri, scope, params;\n    ({ response_type, client_id, redirect_uri, scope } = FHIRConfig.get(ActiveEnv));\n    const state = buildState(launch);\n    const issURl = `${decodeURIComponent(iss)}/metadata`;\n    const response = yield httpService.get(issURl, new Records.AuthorizationHeader());\n    const extension = response.data.rest[0].security.extension[0].extension;\n    const authorizationURL = extension.filter(ext => ext.url === 'authorize')[0].valueUri;\n    const tokenURL = extension.filter(ext => ext.url === 'token')[0].valueUri;\n    const authModel = new Records.UserAuthentication({\n        iss, state, authorizationURL, tokenURL, launch\n    });\n    const model = yield UserAuthenticationModel.save(authModel);\n    params = { response_type, client_id, redirect_uri, scope };\n    util._extend(params, { launch, state, aud });\n    const url = buildRedirectUrl(authorizationURL, params);\n    return url;\n};\n\nconst buildRedirectUrl = (authorizationURL, params) =>\n    `${authorizationURL}?${Object.keys(params).map(key => `${key}=${params[key]}`).join('&')}`;\n\nconst buildState = (launch) => `${launch}${Math.floor(Math.random() * 100000, 1)}${Date.now()}`;\n\n\n"]}